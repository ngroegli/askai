# AskAI CLI - Chat Session Management Flow (Layered Architecture)
title: "Chat Session Management Flow"

chat_request: "Chat Request" {
  shape: oval
  style.fill: "#90CAF9" # Light Blue (core app/user)
}

# Presentation Layer
presentation: "Presentation Layer" {
  shape: rectangle
  style.fill: "#F3E5F5" # Light Purple background

  cli_parse: "CLI Parsing\n(cli/)" {
    shape: diamond
    style.fill: "#CE93D8" # Light Purple (CLI)
  }
}

# Core Layer - Chat Management
core: "Core Layer" {
  shape: rectangle
  style.fill: "#E8F5E9" # Light Green background

  session_check: "Session Check\n(core/chat/manager.py)" {
    shape: diamond
    style.fill: "#A5D6A7" # Light Green (data processing)
  }

  new_session: "Create New Session\n(core/chat/)" {
    shape: rectangle
    style.fill: "#A5D6A7" # Light Green
  }

  load_history: "Load Chat History\n(core/chat/)" {
    shape: rectangle
    style.fill: "#A5D6A7" # Light Green
  }

  context_build: "Build Context\n(core/messaging/builder.py)" {
    shape: rectangle
    style.fill: "#A5D6A7" # Light Green
  }

  ai_call: "AI Service Call\n(core/ai/service.py)" {
    shape: rectangle
    style.fill: "#81C784" # Slightly different green for AI
  }
}

# Output Layer
output: "Output Layer" {
  shape: rectangle
  style.fill: "#FFF9C4" # Light Yellow background

  response_process: "Process Response\n(output/coordinator.py)" {
    shape: rectangle
    style.fill: "#FFF176" # Light Yellow
  }

  display_result: "Display Result\n(output/formatters/)" {
    shape: oval
    style.fill: "#FFF176" # Light Yellow
  }
}

# Utils Layer - Persistence
utils: "Utils Layer" {
  shape: rectangle
  style.fill: "#FAFAFA" # Light Gray background

  store_history: "Store in History\n(via core/chat/ using utils/)" {
    shape: rectangle
    style.fill: "#BDBDBD" # Light Gray (infra)
  }
}

# External Services
external: "External Services" {
  shape: rectangle
  style.fill: "#FFF3E0" # Light Orange

  openrouter: "OpenRouter API" {
    shape: rectangle
    style.fill: "#FFCC80" # Light Orange
  }
}

# Main flow between layers
chat_request -> presentation: "User Command"
presentation -> core: "Parsed Chat Request"
core -> external: "AI Messages"
external -> output: "AI Response"
output -> utils: "Store Results"
output -> presentation: "Formatted Output"
presentation -> chat_request: "User Feedback"

# Detailed component flow
presentation.cli_parse -> core.session_check: "Chat ID"
core.session_check -> core.new_session: "New Session"
core.session_check -> core.load_history: "Existing Session"
core.new_session -> core.context_build: "Empty Context"
core.load_history -> core.context_build: "Historical Context"
core.context_build -> core.ai_call: "Complete Messages"
core.ai_call -> external.openrouter: "HTTP Request"
external.openrouter -> output.response_process: "AI Response"
output.response_process -> utils.store_history: "Formatted Output"
output.response_process -> output.display_result: "User Output"
utils.store_history -> output.display_result: "Success Confirmation"

# Chat Management Details
core.session_check: {
  label: "• Check existing chat files\n• Validate chat ID format\n• Load metadata"
}

core.context_build: {
  label: "• Combine chat history\n• Add current message\n• Maintain context limits"
}

utils.store_history: {
  label: "• JSON chat file format\n• Timestamp tracking\n• Metadata updates"
}
